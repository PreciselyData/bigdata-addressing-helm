{{- if not .Values.global.manualDataConfig.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "hook-{{ .Release.Name }}-config-map"
  labels:
    {{- include "geo-addressing-spark-hook.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/resource-policy": delete
data:
  data-vintage.sh: |
    #!/bin/bash
    
    # Arguments
    volume_mount_path="$1"
    addressing_base_path="$2"
    data_vintage_file="/tmp/$3"
    config_map_name="$4"

    # Initialize
    touch "$data_vintage_file"
    max_vintage=0

    echo "Volume Mount Path: $volume_mount_path"
    echo "Addressing Base Path: $addressing_base_path"
    echo "Data Vintage File: $data_vintage_file"
    echo "ConfigMap Name: $config_map_name"

    # Full path to the addressing data
    addressing_full_path="${volume_mount_path}/${addressing_base_path}"

    echo "Searching for vintages in: $addressing_full_path"

    # Check if the addressing path exists
    if [ ! -d "$addressing_full_path" ]; then
      echo "ERROR: Addressing path does not exist: $addressing_full_path"
      exit 1
    fi

    # Find all numeric directories (vintages) in the addressing base path
    # and determine the maximum vintage
    cd "$addressing_full_path" || exit 1

    for dir in */; do
      # Remove trailing slash
      dir_name="${dir%/}"
      
      # Check if directory name is numeric
      if [[ "$dir_name" =~ ^[0-9]+$ ]]; then
        echo "Found vintage directory: $dir_name"
        
        # Compare to find maximum
        if [ "$dir_name" -gt "$max_vintage" ]; then
          max_vintage="$dir_name"
          echo "  -> New maximum vintage: $max_vintage"
        fi
      fi
    done

    # Check if we found any vintage
    if [ "$max_vintage" -eq 0 ]; then
      echo "ERROR: No valid vintage directories found in $addressing_full_path"
      exit 1
    fi

    echo ""
    echo "Maximum vintage found: $max_vintage"
    echo ""

    # Build the full path with the maximum vintage
    full_vintage_path="${addressing_full_path}/${max_vintage}"

    # Write the configuration to the file with the full path
    # Format: spark-addressing-data.vintage=/mnt/data/geoaddressing-data/spark-addressing-data/202601191759
    echo "${addressing_base_path}.vintage=${full_vintage_path}" > "$data_vintage_file"

    echo "Content of $data_vintage_file:"
    cat "$data_vintage_file"
    echo ""

    # Create or update the ConfigMap
    echo "Creating/updating ConfigMap: $config_map_name"
    kubectl create configmap "$config_map_name" --from-env-file="$data_vintage_file" -o yaml --dry-run=client | kubectl apply -f -

    echo "ConfigMap $config_map_name has been created/updated successfully"
{{- end }}